# Architecting on AWS
AWS 서비스를 파악하고 기능을 비교하며, 복원력있고 안전하며 가용성이 뛰어난 IT 솔루션을 AWS에서 설계한다.
   
# AWS Architect Basic
- 모범 사례에 따라 클라우드 인프라를 어떻게 구성?
- AWS 글로벌 인프라 어떻게 구성?
- 리소스에 대한 액세스 제어?

## AWS 서비스
  
### AWS 사용 이점
- 민첩성 증가: 출시 기간 단축, 혁신 확대, 원활한 스케일링
- 복잡성 및 위험성 감소: 비용 최적화, 보안 강화, 관리 복잡성 감소

### AWS 서비스 연결
1. AWS 관리 콘솔 (70% 정도 제공됨, ID/PW)
1. AWS CLI (Access key ID / Secret access key)
1. AWS SDK (Access key ID / Secret access key)

AWS 내부는 거의 모든 부분이 API로 구성되어 있다.  
명령들이 API로 전달되어 행해진다.

EC2 생성 방법
1. AWS 관리 콘솔: 일회용 또는 임시 인스턴스를 빠르게 시작
1. 스크립트: 반복 사용할 수 있고, 안정적인 방식으로 인스턴스 생성
1. CloudFormation: 관련 리소스를 함께 시작하는 경우, 코드형 인프라 개념을 사용하려는 경우

### 서비스 종류
1. 비관리형 서비스
    - OS 설치, 서버 유지 관리 등 인프라는 AWS가 관리.
    - 인프라에서 발생하는 상황은 고객이 제어.
    - ex. EC2

2. 관리형 서비스
    - 고객은 애플리케이션 최적화만 신경 쓰고, 나머지는 AWS가 관리.
    - ex. RDS

3. 서버리스 서비스
    - 사용자가 가상 머신이나 서버를 소유하지 않고, 필요에 따라 서비스를 프로비저닝.
    - VPC 인프라 내에서 작동하지 않음. (리전 서비스라고도 불림.)
    - 엔드 포인트 URL로 서비스에 접근. (엔드포인트를 통해서 다이렉트로 접근할 수 있다.)

## AWS 인프라
AWS 글로벌 클라우드 인프라는 업계에서 가장 안전하고 광범위하고 안정적인 클라우드 플랫폼으로, 전 세계 데이터 센터를 통해 완전한 기능을 갖춘 200가지가 넘는 서비스를 제공함

### 리전
- 리전 간의 완전히 독립적. (내결함성, 안정성 보장)
- 가용 영역 2개 이상을 가지고 있음. (서울 4개 AZ)
- 가버넌스(규칙), 지연 시간, 서비스 가용성, 비용에 따라 선택

### 가용 영역 (AZ)
- 리전 내 데이터 센터들의 집합. (1개 이상의 데이터 센터를 가지고 있음)
- 내결함성을 갖도록 설계.
- 고속 프라이빗 링크를 통해 상호 연결.
- 고가용성 달성에 사용됨.

### 엣지 로케이션
- 사용자로 부터 가장 가까운 AWS 데이터 센터
- CloudFront의 캐싱 콘텐츠가 한다. 
- Route 53, CloudFront, Global Accelerator, WAF, shield의 제한된 서비스만 제공. (EC2, RDS 서비스 등을 설치할 수 없음)
- 고객이 소비할 데이터가 상파울로의 S3에 있다면 접근할 때마다 시간이 많이 소요될 것이다. 이러한 데이터를 엣지 로케이션에 저장하여, 지연 시간과 비용적 측면에서 이점을 볼 수 있다.

### Local Zone
- 리전까지 너무 멀어서 속도가 너무 느릴 때, 엣지 로케이션에서 특정 서비스를 사용하고 싶을 때 사용.
- 엣지 로케이션에서 EC2, RDS 서비스 등을 제공하는 서비스.  
    (한국은 거리가 먼 지역이 없어서 존재하지 않음)
- 미디어 및 엔터테인먼트 콘텐츠, 실시간 게임, 기계 학습 추론, 스트리밍, AR/VR

### Wavelength
- 5G 사업자를 위한 서비스

## AWS Well-Architected
현재 구축된 아키텍쳐가 잘 구성되었는지 확인하기 위함 (QnA)

### 확인 사항
1. 보안
    - 최소 권한의 원칙
    - MFA (다중 인증) 사용

1. 비용 최적화
    - 비용 효율적 리소스 사용

1. 안정성
    - 장애 복구 절차 테스트
    - 스케일링으로 가용성 최대화

1. 성능 효율성
    - 지연 시간 감소
    - 서버리스 아키텍처 사용
    
1. 운영 우수성
    - 운영 도구를 사용하는가
    - 예기치 않은 이벤트 대응

1. 지속 가능성
    - 환경에 대한 영향 이해

### AWS Well-Arhitected Tool
- 모범 사례와 비교하여 아키텍처 검토
- 워크로드 정의 > 아케턱처 검토 수행(QnA) > 모범사례 적용

### AWS Trusted Advisor
- 모범 사례를 따르는데 도움이 되는 권장 사항 제공.
  
   
# 계정 보안
- AWS 계정 및 리소스에 대한 액세스 권한을 관리하는 모범 사례?
- 리소스에 대한 임시 권한 부여?
- 다중 계정을 관리하는 가장 효과적인 방법?

## 보안 주체
권한을 받는 주체
1. IAM 사용자
1. IAM Role
1. AWS 서비스

### 루트 사용자
- AWS 서비스에 대한 전체 액세스 권한 보유. 
- AWS와의 일상적인 상호 작용에 사용하면 안 됨.
- Account ID(12자리 숫자)가 주어짐. > 이 안에 많은 사용자를 생성할 수 있음
- MFA를 설정할 수 있음

### IAM
- 사용자, 그룹 및 Role(임시 자격/모자)을 생성하고 관리
    - 그룹에 Policy를 연결하고, 속한 사용자들에 적용된다.
- AWS 서비스 및 리소스에 대한 접근 관리
- 액세스 제어 분석

#### IAM Role
- 역할이 있을 때는 역할 정책이 우선적으로 처리됨   
    - 직원에게 교차 계정 접근 권한을 부여
    - AWS 또는 오프레미스에서 실행되는 애플리케이션이 AWS API 호출을 수행하도록 허용
    - AWS 서비스가 사용자 대신 AWS API 호출을 수행하도록 허용
- STS (Security Token Service): 임시 보안 자격 증명을 생성  
    Access key, Security Key, Session Token  
    SAML, Web Identity
- ex. EC2가 S3에 접근할 때마다 Role을 부여받아 사용한다. (EC2 메타데이터를 활용)  
ex. Account가 다를 때, switching role을 통해서 다른 Account의 권한을 변환할 수 있음

## 보안 정책
Json 형태로 액세스 권한을 평가

### 정책 유형

권한 부여   
- 자격 증명 기반 정책: 사용자 중심 (Users, Groups, Role)
    - managed: 대상이 사라져도 유지가 됨 (1:n) (AWS, Customer)
    - inline: 대상이 사라지면 사라짐 (1:1)
- 리소스 기반 정책: 리소스 중심 (S3, Bucket), 모두 inline (리소스가 사라지면 사라짐)

최대 권한 설정  
- IAM 권한 경계
- AWS Organizations 서비스 제어 정책 (SCP)

권한 평가  
자격 증명 기반 정책과 리소스 기반 정책은 함께 평가된다.  
1. 명시적 거부? > DENY
1. 명시적 허용? > ALLOW
1. 묵시적 거부 > DENY

### 심층 방어
- 사용자 > (IAM 정책) > IAM Role
- IAM Role > (VPC 엔드포인트 정책) > Amazon S3 VPC 엔드포인트
- Amazon S3 VPC 엔드포인트 > (버킷 정책) > S3 버킷
- AWS KMS 키 > (AWS KMS 키 정책) > 문서

### 정책 요소
- Effect* : 정책에서 액세스를 Allow/Deny 표시
- Principle : 계정, 사용자, 역할 또는 페더레이션 사용자로 액세스를 허용할 것인가 (리소스 정책에서만)
- Action* : 정책이 허용하거나 거부하는 작업 목록
- Resource* : Action이 적용되는 리소스 목록
- Condition : 정책에서 권한을 부여하는 상황 정의

```json
{
    "Version": "2012–10–17",
    "Statement": {
        "Effect": "Allow", // Allow 또는 Deny
        // 해당되는 작업에 접근할 수 있다.
        "Action": [
            "dynamodb:*",
            "s3:*",
            "iam:GetGroup"
        ],
        // 해당 리소스에 접근할 수 있다.
        "Resource": [
            "arn:aws:dynamodb:region:account-number-without-hyphens:table/EXAMPLE-TABLE"
            "arn:aws:iam::609103258633:group/Developers",
            "arn:aws:iam::609103258633:group/Operators"
        ],
        // 사용자가 Owner일 때만 Action을 하겠다.
        "Condition" : {
            "StrginEquals":{
                "ec2:ResourceTag/Owner": "${aws:username}"
            }
        }
    }
}
```

### 계정 페더레이션
- 팀 인증을 단순화하기 위함
- 단기 보안 인증 정보는 외부 사용자에게 액세스 권한을 제공.
- 통합 인증(SSO)를 위해 회사 계정과 AWS 계정을 일치 시킴

## 다중 계정 관리 
- 다수의 팀
- 보안 및 규정 준수 제어
- 결제
- 격리

### AWS Organizations
- 다중 계정 관리를 위해서 계정을 조직 단위(OU, Organization Unit)으로 그룹화하여 계층 구조를 생성
- OU 내 모든 계정에 SCP(Service Control Policy)가 적용
- 통합 과금 방식의 장점을 활용, 무료임.
- IAM과 Organizaion의 교집합만이 허용됨.
- 만약, Organization이 없다면 같은 정책임에도 계정이 다르면 중복 작업을 해줘야함.

AWS Organizations vs IAM Group  
- Organizations: 전체에 적용되는 최대 허용을 제한. Deny 위주
- IAM Group: IAM 그룹에 속한 사용자가 특정 서비스를 활용할 수 있다. Allow 위주

### AWS Control Tower
- 다중 계정을 처음에 모범사례를 활용하여 쉽게 구축.
- 거버넌스(규약)를 적용.
- 로그 아카이브, 교차 계정 감사, 프로비저닝된 계정 등의 여러 서비스를 추상화하여 적용.


# 네트워킹

## IP 주소 지정
AWS에서 IP 주소 공간 계획하기.

### CIDR 표기법
VPC 안에서 어떻게 IP를 사용할 것인가를 결정 (총 5개의 CIDR 블록이 있음)

- 192.168.1.0/24  
    앞에 3개는 고정하고(24/8=3) 맨 뒤만 변경해서 2^8 만큼 사용하겠다.
- 10.0.0.0/16  
    앞에 2개는 고정하고(16/8=2) 2 개만 변경해서 2^8 * 2^8 만큼 사용하겠다.

#### Public/Private IP
- Public IP: 인터넷을 통해서 연결할 수 있는 IPv4 주소
- Private IP: 인터넷에 접근할 수 없음

## VPC 기본 사항

### VPC
- 워크로드의 논리적 격리를 제공
- 단일 리전 
- 2개 이상의 가용 영역을 포함함
- 초기에 기본 VPC가 제공됨

#### 여러 가용 영역에 VPC 배포
- 여러 가용 영역에 배포하여 고가용성 달성.
- 각 가용 영역에 서브넷을 생성, 리소스를 배포
- ELB를 통해서 가용 영역 간에 트래픽을 분산

#### 다중 VPC 이점
- 각 애플리케이션 환경의 모든 리소스 프로비저닝 및 관리를 완전히 제어하는 단일 팀 또는 조직에 적합
- 다중 VPC는 논리적 격리를 생성할 수 있음
- AWS Organizations, Control Tower 등을 통해

### 서브넷
- VPC CIDR 블록의 하위 집합 (VPC의 IP를 나누어 사용하겠다.)
- 하나의 가용 영역에 여러개가 포함될 수 있음
    - 생성시, 기본 Private 서브넷
    - 일반적으로 public 서브넷 개수 < Private 서브넷 개수

#### Public 서브넷
- 공인 IP 주소를 통한 외부 통신이 가능 (공인 IP와 사설 IP를 가짐)
- 라우팅 테이블에 (대상위치: 0.0.0.0/0 | 대상: igw-id) 추가
    - igw: 인터넷 게이트웨이
- 인바운드/아웃바운드 가능

#### 인터넷 게이트웨이
- VPC 인스턴스와 인터넷 간 통신을 위해서 반드시 필요 
- VPC당 하나 설정할 수 있음
- 기본적으로 수평 확장, 중복, 고가용성
- 인터넷으로 라우팅 가능한 트래픽에 대한 서브넷 라우팅 테이블에 대상을 제공
    - 라우팅 테이블 : 대상위치, 대상이 정의되어 있음  

<img src="https://blog.kico.co.kr/wp-content/uploads/2022/03/%EC%9D%B4%EB%AF%B8%EC%A7%80-10110.png" height = 350>

### ENI(Elastic Network Interface)
- Priavet IP 주소, Elastic IP 주소, Mac 주소를 유지
- 동일한 가용영역의 리소스 간에 이동이 가능

### NAT(Network Address Translation)
- Private 서브넷의 아웃바운드 트래픽을 보내기 위해서 필요 
- Public 서브넷를 거침

<img src="https://elegantcoder.com/wp-content/uploads/2019/07/nat-gateway-diagram-738x510.png" height = 400>

### 가상 방화벽
#### Network ACL (Access Control List)
- 1차 보안 계층
- VPC 서브넷의 가상 방화벽
- 모든 VPC에는 기본 NACL이 포함된다. (인바운드/아웃바운드 모두 허용)
- 상태 비저장. 모든 트래픽에 대한 명시적 규칙이 필요.
- 번호가 가장 낮은 규칙부터 평가

#### Security Group
- 2차 보안 계층
- 인스턴스의 가상 방화벽 (리소스의 ENI에 걸려있는 가상 방화벽)
- 인바운드/아웃바운드 수동 제어 (인바운드 모두 거부/아웃바운드 모두 허용)
- 보안 그룹 연결
    - 트래픽이 상위 티어로 흐른 후 다시 반대로 흐르도록 설정
    - 인바운드/아웃바운드 규칙에 의해 설정 가능

<img src="https://lh6.googleusercontent.com/9YpYXmCU-aCyEyCgutFTNJd6hTbCp79I1qoz1Iz_ZY85IbbOU2Rv8Vg89_4jhbb3tnt6_YGf_RRKlqDmIbz4XGpl2cdtc8v1fIFoAx9S2U54NrMGns05XAJsLYGAAGA4CCU7K_8" width=500>


# 컴퓨팅
- AWS 컴퓨팅 서비스 종류?
- AMI란 무엇인가?
- 비용 최적화는 어떻게?
- Lambda는 무엇인가?

## 컴퓨팅 서비스
1. Amazon EC2  
    AWS 클라우드 컴퓨팅의 중심 구성 요소. 가상화 서버
1. Amazon ECS(Elastic Container Service)  
    Docker 컨테이너를 사용하여 EC2 인스턴스의 관리형 클러스터에서 분산 애플리케이션 기능 도입
1. AWS Lambda  
    서버리스. 완전 관리형 서비스.
1. AWS Fargate  
    ECS는 결국 가상 서버에 올리는 것이다. (EC2에 올라감)  
    따라서 컨테이너를 좀 더 자동화하여 사용하기 위해서 나타남

## EC2 인스턴스
- 안전하고 크기 조정 가능한 컴퓨팅 용량을 제공함. 
- 수요 변화에 맞춰 컴퓨팅 용량 추가/제거 가능.
- 리전의 물리 서버가 EC2 인스턴스를 호스트.

### AMI (Amazon Machine Image)
- 인스턴스의 소프트웨어를 결정한다.
    - Linux, Windows, 64/32 bit 등
- 이점: 반복, 재사용, 복구 가능
- 작성된 인스턴스에서 생성할 수 있음. (Amazon EC2 Image Builder)
- AWS 기본 제공/Marketplace/community AMI

### Instance type
- 인스턴스의 하드웨어를 설정한다.
- F.G.A.S 유형 (t3n.large)
    - Family: CPU 타입을 저장한다. 
        - 범용: 메모리:vCPU = 4:1   
        (t시리즈: 기준 성능 이상의 버스팅을 할 수 있음. 트래픽이 들쑥날쑥할 때 사용 / m시리즈. 트래픽이 안정적일때)
        - 메모리 최적화: 메모리:vCPU = 8:1
        - 스토리지 최적화: 스토리지 읽고 쓰기가 빈번한 컴퓨팅
        - 컴퓨팅 최적화: 메모리:vCPU = 2:1
        - 액셀러레이티드 컴퓨팅: GPU 중심. 머신러닝 등을 위한 컴퓨팅.
    - Generation: 인스턴스 세대 (최신 CPU가 가성비가 좋음)
    - Attribute: 속성 (n: 네트워크 )
    - Size: 인스턴스 크기 
- EBS Optimized
    - 인스턴스 스토어  
    EC2에 포함된 스토리지   
    휘발성이 있다. 빠르다.  
    모든 인스턴스에 있지는 않다.  
    - EBS  
    EC2와 연결된 스토리지  
    비휘발성. 주기적으로 스냅샷. 무료임.  
    SSD(빠르다)와 HDD로 나누어져 있음  

### 사용자 데이터
- 인스턴스가 시작할 때 루트 사용자로 스크립트를 실행
- 공통적인 자동화 구성 태스크를 수행하는 데에 사용

### 메타데이터
- 인스턴스가 가지고 있는 고유의 정보
- 자동화에 사용할 수 있음
- 해당 인스턴스에서만 참조할 수 있음

### Tag
- AWS 리소스에 태그를 할당함
- 리소스 관리, 검색 및 필터링
- 태그는 많은 것이 좋음

## EC2 요금제 옵션
아래 설명되는 인스턴스들을 섞어서 사용함

### 예약 인스턴스
- 약정 및 안정적 상태의 사용량
- 온디맨드 요금 대비 할인
- 1년 또는 3년

#### 표준 예약 인스턴스
- 온디맨드 대비 최대 72% 할인
- 사용량이 지속적인 경우

#### 컨버터블 예약 인스턴스
- 온디맨드 대비 최대 54% 할인
- 변경 결과가 동일하거나 더 높은 값이면 예약 인스턴스의 속성 변경 가능

### Savings Plans
- 예약 인스턴스에서 더 높은 유연성 (Fargate, Lambda 사용량에 적용됨)
- 1년 또는 3년

### 스팟 인스턴스
- 내결함성, 유연성, 무상태 워크로드
- AWS 용량을 필요할 때 가져다 쓸 수 있다.
- 온디맨드 요금 대비 최대 90% 할인
- AWS가 필요할 때 언제든지 가져감 (2분 Notice)

### 온디맨드 인스턴스 
- 들쭉날쭉 워크로드 또는 일시적 필요
- 약정없이 시간 단위로 컴퓨팅 용량을 구입

## 스토리지

### Amazon EBS
- 블록 단위로 데이터가 저장됨
- EC2 인스턴스와 독립적으로 지속됨 (비휘발성)
- 가용 영역 내에서 정의됨 (인스턴스와 연결하기 위해서)
- 99.999% 가용성
- 스냅샷을 통한 백업 (S3)

#### 유형
1. SSD
    - 메모리 중심. 속도가 빠르다.
    - 고성능, 범용 워크로드에 사용
1. HDD
    - 처리량 최적화
    - 빅데이터 및 자주 접근하지 않는 데이터

### 인스턴스 스토어 볼륨
- 인스턴스에 로컬로 연결
- 지속적이지 않음 (휘발성)
- 스냅샷을 지원하지 않음
